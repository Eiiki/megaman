"use strict";function handleKeydown(t){keys[t.keyCode]=!0,keyUpKeys[t.keyCode]=!1}function handleKeyup(t){keys[t.keyCode]=!1,keyUpKeys[t.keyCode]=!0}function eatKey(t){var e=keys[t];return keys[t]=!1,e}function keyCode(t){return t.charCodeAt(0)}function handleMouse(t){g_mouseX=t.clientX-g_canvas.offsetLeft,g_mouseY=t.clientY-g_canvas.offsetTop;var e=void 0===t.buttons?t.which:t.buttons}function Sprite(t,e,i,a,n){void 0===e&&(e=0),void 0===i&&(i=0),this.sx=e,this.sy=i,this.width=a||t.width,this.height=n||t.height,this.image=t,this.scale=1}function Entity(){}function Bricks(t){this.setup(t),this.sprite=this.sprite||g_sprites.brick,this._scale=1}function Bullet(t){this.setup(t),this.sprite=this.sprite||g_sprites.bullet,this._scale=.15}function Megaman(t){this.setup(t),this.sprite=this.sprite||g_sprites.megaman_still,this._scale=2.5,this._verticalSpeed=4,this._initialJumpSpeed=12,this._isFiringBullet=!1,this._hasJumped=!1}function update(t){if(!shouldSkipUpdate()){var e=t;t>200&&(console.log("Big dt =",t,": CLAMPING TO NOMINAL"),t=NOMINAL_UPDATE_INTERVAL);var i=t/NOMINAL_UPDATE_INTERVAL;updateSimulation(i),g_prevUpdateDt=e,g_prevUpdateDu=i,g_isUpdateOdd=!g_isUpdateOdd}}function shouldSkipUpdate(){return eatKey(KEY_PAUSE)&&(g_isUpdatePaused=!g_isUpdatePaused),g_isUpdatePaused&&!eatKey(KEY_STEP)}function render(t){if(eatKey(TOGGLE_CLEAR)&&(g_doClear=!g_doClear),eatKey(TOGGLE_BOX)&&(g_doBox=!g_doBox),eatKey(TOGGLE_UNDO_BOX)&&(g_undoBox=!g_undoBox),eatKey(TOGGLE_FLIPFLOP)&&(g_doFlipFlop=!g_doFlipFlop),eatKey(TOGGLE_RENDER)&&(g_doRender=!g_doRender),g_doClear&&util.clearCanvas(t),g_doBox&&util.fillBox(t,200,200,50,50,"red"),g_doRender&&renderSimulation(t),g_doFlipFlop){var e=250,i=g_isUpdateOdd?100:200;util.fillBox(t,e,i,50,50,"green"),t.fillText(g_frameCounter%1e3,e+10,i+20);var a=g_frameCounter%2?"odd":"even";t.fillText(a,e+10,i+40)}g_undoBox&&t.clearRect(200,200,50,50),++g_frameCounter}function imagesPreload(t,e,i){var a,n=0,s,r,o;a=Object.keys(t).length,o=function(){console.log("preloadHandler called with this=",this),e[this.name]=this,0===this.width&&console.log("loading failed for",this.name),this.onload=null,this.onerror=null,n+=1,n===a&&(console.log("all preload images handled"),console.log("loadedImages=",e),console.log(""),console.log("performing completion callback"),i(),console.log("completion callback done"),console.log(""))};for(s in t)t.hasOwnProperty(s)&&(console.log("preloading image",s),r=new Image,r.name=s,r.asyncLoad(t[s],o))}function requestedQuit(){return keys[KEY_QUIT]}function mainIterFrame(t){main.iter(t)}function createMegaman(){entityManager.generateMegaman({cx:100,cy:100,velX:0,velY:-.5})}function gatherInputs(){}function updateSimulation(t){processDiagnostics(),entityManager.update(t)}function processDiagnostics(){eatKey(KEY_SPATIAL)&&(g_renderSpatialDebug=!g_renderSpatialDebug)}function renderSimulation(t){entityManager.render(t),g_renderSpatialDebug&&spatialManager.render(t)}function requestPreloads(){var t={megaman_sprite:"sprites/8bitmegaman.png",bullet_sprite:"sprites/bullet.png",brick:"sprites/TileBrick.jpg"};imagesPreload(t,g_images,preloadDone)}function preloadDone(){g_sprites.megaman_still=new Sprite(g_images.megaman_sprite,103,10,21,24),g_sprites.megaman_jump=new Sprite(g_images.megaman_sprite,265,4,26,30),g_sprites.megaman_running=[new Sprite(g_images.megaman_sprite,188,12,24,22),new Sprite(g_images.megaman_sprite,218,10,16,24),new Sprite(g_images.megaman_sprite,239,12,21,22),new Sprite(g_images.megaman_sprite,218,10,16,24)],g_sprites.megaman_fire={still:new Sprite(g_images.megaman_sprite,14,45,31,24),running:[new Sprite(g_images.megaman_sprite,50,48,29,22),new Sprite(g_images.megaman_sprite,84,46,26,24),new Sprite(g_images.megaman_sprite,113,48,30,22),new Sprite(g_images.megaman_sprite,84,46,26,24)],jumping:new Sprite(g_images.megaman_sprite,146,40,29,30)},g_sprites.bullet=new Sprite(g_images.bullet_sprite),g_sprites.brick=new Sprite(g_images.brick),entityManager.init(),createMegaman(),main.init()}var g_canvas=document.getElementById("myCanvas"),g_ctx=g_canvas.getContext("2d"),NOMINAL_UPDATE_INTERVAL=16.666,SECS_TO_NOMINALS=1e3/NOMINAL_UPDATE_INTERVAL,consts={FULL_CIRCLE:2*Math.PI,RADIANS_PER_DEGREE:Math.PI/180},util={circlesCollides:function(t,e,i,a,n,s){var r=util.square(i-s),o=util.square(i+s),l=util.square(t-a),p=util.square(e-n),u=l+p;return u>=r&&o>=u},clampRange:function(t,e,i){return e>t?t=e:t>i&&(t=i),t},wrapRange:function(t,e,i){for(;e>t;)t+=i-e;for(;t>i;)t-=i-e;return t},isBetween:function(t,e,i){return e>t?!1:t>i?!1:!0},almostEqual:function(t,e){return Math.abs(this.square(t)-this.square(e))<.1},randRange:function(t,e){return t+Math.random()*(e-t)},square:function(t){return t*t},distSq:function(t,e,i,a){return this.square(i-t)+this.square(a-e)},wrappedDistSq:function(t,e,i,a,n,s){var r=Math.abs(i-t),o=Math.abs(a-e);return r>n/2&&(r=n-r),o>s/2&&(o=s-o),this.square(r)+this.square(o)},playSoundNow:function(t,e){void 0===e&&(e=0),t.currentTime>e&&(t.pause(),t.currentTime=0),t.play()},clearCanvas:function(t){var e=t.fillStyle;t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle=e},strokeCircle:function(t,e,i,a){t.beginPath(),t.arc(e,i,a,0,2*Math.PI),t.stroke()},fillCircle:function(t,e,i,a){t.beginPath(),t.arc(e,i,a,0,2*Math.PI),t.fill()},strokeBox:function(t,e,i,a,n){t.beginPath(),t.rect(e,i,a,n),t.stroke()},fillBox:function(t,e,i,a,n,s){var r=t.fillStyle;t.fillStyle=s,t.fillRect(e,i,a,n),t.fillStyle=r}},keys=[],keyUpKeys=[];window.addEventListener("keydown",handleKeydown),window.addEventListener("keyup",handleKeyup);var g_mouseX=0,g_mouseY=0;window.addEventListener("mousedown",handleMouse),window.addEventListener("mousemove",handleMouse);var spatialManager={_nextSpatialID:1,_entities:[],getNewSpatialID:function(){return this._nextSpatialID++},register:function(t){var e=t.getPos(),i=t.getSpatialID(),a=t.sprite.width*t._scale,n=t.sprite.height*t._scale,s={posX:e.posX-a/2,posY:e.posY-n/2,width:a,height:n};this._entities[i]=s},unregister:function(t){var e=t.getSpatialID(),i=this._entities[e];i&&(i.posY=void 0,i.posX=void 0)},findEntityInRange:function(t,e,i){return entityManager.deferredSetup(),!1},render:function(t){var e=t.strokeStyle;t.strokeStyle="red";for(var i in this._entities){var a=this._entities[i];util.strokeBox(t,a.posX,a.posY,a.width,a.height)}t.strokeStyle=e}},entityManager={_character:[],_bullets:[],_bShowRocks:!0,_forEachOf:function(t,e){for(var i=0;i<t.length;++i)e.call(t[i])},KILL_ME_NOW:-1,deferredSetup:function(){this._categories=[this._bullets,this._character]},init:function(){},fireBullet:function(t,e,i,a){this._bullets.push(new Bullet({cx:t,cy:e,velX:i,velY:a}))},generateMegaman:function(t){this._character.push(new Megaman(t))},yoinkMegamanToPos:function(t,e){},update:function(t){for(var e=0;e<this._categories.length;++e)for(var i=this._categories[e],a=0;a<i.length;){var n=i[a].update(t);n===this.KILL_ME_NOW?i.splice(a,1):++a}},render:function(t){for(var e=10,i=100,a=0;a<this._categories.length;++a){for(var n=this._categories[a],s=0;s<n.length;++s)n[s].render(t);i+=10}}};entityManager.deferredSetup(),Sprite.prototype.drawCentredAt=function(t,e,i,a,n){void 0===n&&(n=0);var s=this.width,r=this.height;t.save(),t.translate(e,i),t.rotate(n),t.scale(this.scale,this.scale),a&&t.scale(-1,1),t.drawImage(this.image,this.sx,this.sy,s,r,-s/2,-r/2,s,r),a&&t.scale(-1,1),t.restore()},Sprite.prototype.drawWrappedCentredAt=function(t,e,i,a,n){var s=g_canvas.width;this.drawWrappedVerticalCentredAt(t,e,i,a,n)},Sprite.prototype.drawWrappedVerticalCentredAt=function(t,e,i,a,n){var s=g_canvas.height;this.drawCentredAt(t,e,i,a,n)},Entity.prototype.setup=function(t){for(var e in t)this[e]=t[e];this._spatialID=spatialManager.getNewSpatialID(),this._isDeadNow=!1},Entity.prototype.setPos=function(t,e){this.cx=t,this.cy=e},Entity.prototype.getPos=function(){return{posX:this.cx,posY:this.cy}},Entity.prototype.getRadius=function(){return this.getRadius()},Entity.prototype.getSpatialID=function(){return this._spatialID},Entity.prototype.kill=function(){this._isDeadNow=!0},Entity.prototype.findHitEntity=function(){var t=this.getPos();return spatialManager.findEntityInRange(t.posX,t.posY,this.getRadius())},Entity.prototype.isColliding=function(){return this.findHitEntity()},Entity.prototype.wrapPosition=function(){this.cx=util.wrapRange(this.cx,0,g_canvas.width),this.cy=util.wrapRange(this.cy,0,g_canvas.height)},Bricks.prototype=new Entity,Bricks.prototype.height=0,Bricks.prototype.width=0,Bullet.prototype=new Entity,Bullet.prototype.zappedSound=new Audio("sounds/enemy_takes_hit.wav"),Bullet.prototype.update=function(t){if(spatialManager.unregister(this),this.cx+=this.velX*t,this.cy+=this.velY*t,this.cx>g_canvas.width||this.cx<0)return this.takeBulletHit(),entityManager.KILL_ME_NOW;this.wrapPosition();var e=this.findHitEntity();if(e){var i=e.takeBulletHit;return i&&i.call(e),entityManager.KILL_ME_NOW}spatialManager.register(this)},Bullet.prototype.getRadius=function(){return Math.max(this.sprite.width/2,this.sprite.height/2)*this._scale},Bullet.prototype.takeBulletHit=function(){this.kill(),util.playSoundNow(this.zappedSound,.2)},Bullet.prototype.render=function(t){var e=this.sprite.scale;this.sprite.scale=this._scale,g_sprites.bullet.drawWrappedCentredAt(t,this.cx,this.cy,this.rotation),this.sprite.scale=e},Megaman.prototype=new Entity,Megaman.prototype.KEY_JUMP="W".charCodeAt(0),Megaman.prototype.KEY_LEFT="A".charCodeAt(0),Megaman.prototype.KEY_RIGHT="D".charCodeAt(0),Megaman.prototype.KEY_FIRE=" ".charCodeAt(0),Megaman.prototype.launchVel=2,Megaman.prototype.numSubSteps=1,Megaman.prototype.isFlipped=!1,Megaman.prototype.jumpSound=new Audio("sounds/megaman_jump.wav"),Megaman.prototype.fireSound=new Audio("sounds/megaman_fire_bullet.wav");var g_runningSprite=0,g_bulletSpriteCnt=0,g_hasShotBullet=!1;Megaman.prototype._updateSprite=function(t,e){var i=this.velX,a=this.velY,n=8;if(0>i?this.isFlipped=!0:i>0&&(this.isFlipped=!1),0===t&&(g_runningSprite=0),this._isFiringBullet&&(g_hasShotBullet=!0,g_bulletSpriteCnt++),0!==a)this.sprite=g_hasShotBullet&&g_hasShotBullet?g_sprites.megaman_fire.jumping:g_sprites.megaman_jump;else if(0===i)this.sprite=g_hasShotBullet&&g_hasShotBullet?g_sprites.megaman_fire.still:g_sprites.megaman_still;else{var s=Math.floor(g_runningSprite++/n);this.sprite=g_hasShotBullet&&g_hasShotBullet?g_sprites.megaman_fire.running[s]:g_sprites.megaman_running[s]}g_runningSprite>=g_sprites.megaman_running.length*n&&(g_runningSprite=0),g_hasShotBullet&&20>g_bulletSpriteCnt?g_bulletSpriteCnt++:(g_bulletSpriteCnt=0,g_hasShotBullet=!1)},Megaman.prototype.update=function(t){if(spatialManager.unregister(this),this._isDeadNow)return spatialManager.KILL_ME_NOW;for(var e=this.velX,i=this.velY,a=this.numSubSteps,n=t/a,s=0;a>s;++s)this.computeSubStep(n);this.maybeFireBullet(),spatialManager.register(this),this._updateSprite(e,i),this.isColliding()||spatialManager.register(this)},Megaman.prototype.computeSubStep=function(t){this.updatePosition(t)};var NOMINAL_GRAVITY=.7;Megaman.prototype.computeGravity=function(){return NOMINAL_GRAVITY},Megaman.prototype.computeThrustX=function(){var t=0;return keys[this.KEY_RIGHT]&&(t+=this._verticalSpeed),keys[this.KEY_LEFT]&&(t-=this._verticalSpeed),t},Megaman.prototype.updatePosition=function(t){var e=this.sprite.width/2*this._scale,i=this.sprite.height/2*this._scale,a=g_canvas.width-e,n=e,s=g_canvas.height-i,r=i,o=this.velX,l=this.velY,p=this.computeGravity();this.velX=this.computeThrustX(),this.cx=util.clampRange(this.cx+t*this.velX,n,a),keyUpKeys[this.KEY_JUMP]&&(this._hasJumped=!1),0===l&&keys[this.KEY_JUMP]&&!this._hasJumped&&(this.velY=this._initialJumpSpeed,this._hasJumped=!0),0!==l&&(util.almostEqual(l,0)?this.velY=-.5:this.velY-=p*t),this.cy-=t*this.velY,this.cy>s&&(this.cy=s,this.velY=0,util.playSoundNow(this.jumpSound)),this.cy=util.clampRange(this.cy,r,s)},Megaman.prototype.maybeFireBullet=function(){if(keys[this.KEY_FIRE]||(this._isFiringBullet=!1),keys[this.KEY_FIRE]&&!this._isFiringBullet){var t=0,e=this.isFlipped?-10:10;this._isFiringBullet=!0,entityManager.fireBullet(this.cx,this.cy,e,t),util.playSoundNow(this.fireSound,.2)}},Megaman.prototype.getRadius=function(){return Math.max(this.sprite.width,this.sprite.height)/2*this._scale},Megaman.prototype.halt=function(){this.velX=0,this.velY=0},Megaman.prototype.render=function(t){var e=this.sprite.scale;this.sprite.scale=this._scale,this.sprite.drawWrappedCentredAt(t,this.cx,this.cy,this.isFlipped),this.sprite.scale=e};var NOMINAL_UPDATE_INTERVAL=16.666,g_prevUpdateDt=null,g_prevUpdateDu=null,g_isUpdateOdd=!1,KEY_PAUSE="P".charCodeAt(0),KEY_STEP="O".charCodeAt(0),g_isUpdatePaused=!1,g_doClear=!0,g_doBox=!1,g_undoBox=!1,g_doFlipFlop=!1,g_doRender=!0,g_frameCounter=1,TOGGLE_CLEAR="C".charCodeAt(0),TOGGLE_BOX="B".charCodeAt(0),TOGGLE_UNDO_BOX="U".charCodeAt(0),TOGGLE_FLIPFLOP="F".charCodeAt(0),TOGGLE_RENDER="R".charCodeAt(0),canvas=document.getElementById("myCanvas"),ctx=canvas.getContext("2d");Image.prototype.asyncLoad=function(t,e){this.onload=e,this.onerror=e,console.log("requesting image src of ",t),this.src=t};var main={_frameTime_ms:null,_frameTimeDelta_ms:null};main.iter=function(t){this._updateClocks(t),this._iterCore(this._frameTimeDelta_ms),this._debugRender(g_ctx),this._isGameOver||this._requestNextIteration()},main._updateClocks=function(t){null===this._frameTime_ms&&(this._frameTime_ms=t),this._frameTimeDelta_ms=t-this._frameTime_ms,this._frameTime_ms=t},main._iterCore=function(t){return requestedQuit()?void this.gameOver():(gatherInputs(),update(t),void render(g_ctx))},main._isGameOver=!1,main.gameOver=function(){this._isGameOver=!0,console.log("gameOver: quitting...")};var KEY_QUIT="Q".charCodeAt(0);window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame,main._requestNextIteration=function(){window.requestAnimationFrame(mainIterFrame)};var TOGGLE_TIMER_SHOW="T".charCodeAt(0);main._doTimerShow=!1,main._debugRender=function(t){if(eatKey(TOGGLE_TIMER_SHOW)&&(this._doTimerShow=!this._doTimerShow),this._doTimerShow){var e=350;t.fillText("FT "+this._frameTime_ms,50,e+10),t.fillText("FD "+this._frameTimeDelta_ms,50,e+20),t.fillText("UU "+g_prevUpdateDu,50,e+30),t.fillText("FrameSync ON",50,e+40)}},main.init=function(){g_ctx.fillStyle="white",this._requestNextIteration()};var g_canvas=document.getElementById("myCanvas"),g_ctx=g_canvas.getContext("2d"),g_renderSpatialDebug=!1,KEY_SPATIAL=keyCode("X"),g_images={},g_sprites={};requestPreloads();
//# sourceMappingURL=./GAME.min.js.map