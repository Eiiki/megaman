"use strict";function handleKeydown(e){keys[e.keyCode]=!0,keyUpKeys[e.keyCode]=!1}function handleKeyup(e){keys[e.keyCode]=!1,keyUpKeys[e.keyCode]=!0}function eatKey(e){var t=keys[e];return keys[e]=!1,t}function keyCode(e){return e.charCodeAt(0)}function handleMouse(e){g_mouseX=e.clientX-g_canvas.offsetLeft,g_mouseY=e.clientY-g_canvas.offsetTop;var t=void 0===e.buttons?e.which:e.buttons}function Sprite(e,t,i,a,n){void 0===t&&(t=0),void 0===i&&(i=0),this.sx=t,this.sy=i,this.width=a||e.width,this.height=n||e.height,this.image=e,this.scale=1}function Entity(){}function Bricks(e){this.setup(e),this.sprite=this.sprite||g_sprites.brick,this._scale=1}function Bullet(e){this.setup(e),this.sprite=this.sprite||g_sprites.bullet,this._scale=.15}function Megaman(e){this.setup(e),this.sprite=this.sprite||g_sprites.megaman_still,this._scale=2.5,this._verticalSpeed=4,this._initialJumpSpeed=12,this._isFiringBullet=!1,this._hasJumped=!1}function update(e){if(!shouldSkipUpdate()){var t=e;e>200&&(console.log("Big dt =",e,": CLAMPING TO NOMINAL"),e=NOMINAL_UPDATE_INTERVAL);var i=e/NOMINAL_UPDATE_INTERVAL;updateSimulation(i),g_prevUpdateDt=t,g_prevUpdateDu=i,g_isUpdateOdd=!g_isUpdateOdd}}function shouldSkipUpdate(){return eatKey(KEY_PAUSE)&&(g_isUpdatePaused=!g_isUpdatePaused),g_isUpdatePaused&&!eatKey(KEY_STEP)}function render(e){if(eatKey(TOGGLE_CLEAR)&&(g_doClear=!g_doClear),eatKey(TOGGLE_BOX)&&(g_doBox=!g_doBox),eatKey(TOGGLE_UNDO_BOX)&&(g_undoBox=!g_undoBox),eatKey(TOGGLE_FLIPFLOP)&&(g_doFlipFlop=!g_doFlipFlop),eatKey(TOGGLE_RENDER)&&(g_doRender=!g_doRender),g_doClear&&util.clearCanvas(e),g_doBox&&util.fillBox(e,200,200,50,50,"red"),g_doRender&&renderSimulation(e),g_doFlipFlop){var t=250,i=g_isUpdateOdd?100:200;util.fillBox(e,t,i,50,50,"green"),e.fillText(g_frameCounter%1e3,t+10,i+20);var a=g_frameCounter%2?"odd":"even";e.fillText(a,t+10,i+40)}g_undoBox&&e.clearRect(200,200,50,50),++g_frameCounter}function imagesPreload(e,t,i){var a,n=0,s,r,o;a=Object.keys(e).length,o=function(){console.log("preloadHandler called with this=",this),t[this.name]=this,0===this.width&&console.log("loading failed for",this.name),this.onload=null,this.onerror=null,n+=1,n===a&&(console.log("all preload images handled"),console.log("loadedImages=",t),console.log(""),console.log("performing completion callback"),i(),console.log("completion callback done"),console.log(""))};for(s in e)e.hasOwnProperty(s)&&(console.log("preloading image",s),r=new Image,r.name=s,r.asyncLoad(e[s],o))}function requestedQuit(){return keys[KEY_QUIT]}function mainIterFrame(e){main.iter(e)}function createMegaman(){entityManager.generateMegaman({cx:100,cy:100,velX:0,velY:-.5})}function gatherInputs(){}function updateSimulation(e){processDiagnostics(),entityManager.update(e)}function processDiagnostics(){eatKey(KEY_SPATIAL)&&(g_renderSpatialDebug=!g_renderSpatialDebug)}function renderSimulation(e){entityManager.render(e),g_renderSpatialDebug&&spatialManager.render(e)}function requestPreloads(){var e={megaman_sprite:"sprites/8bitmegaman.png",bullet_sprite:"sprites/bullet.png",brick:"sprites/TileBrick.jpg"};imagesPreload(e,g_images,preloadDone)}function preloadDone(){g_sprites.megaman_still=new Sprite(g_images.megaman_sprite,103,10,21,24),g_sprites.megaman_jump=new Sprite(g_images.megaman_sprite,265,4,26,30),g_sprites.megaman_running=[new Sprite(g_images.megaman_sprite,188,12,24,22),new Sprite(g_images.megaman_sprite,218,10,16,24),new Sprite(g_images.megaman_sprite,239,12,21,22),new Sprite(g_images.megaman_sprite,218,10,16,24)],g_sprites.megaman_fire={still:new Sprite(g_images.megaman_sprite,14,45,31,24),running:[new Sprite(g_images.megaman_sprite,50,48,29,22),new Sprite(g_images.megaman_sprite,84,46,26,24),new Sprite(g_images.megaman_sprite,113,48,30,22),new Sprite(g_images.megaman_sprite,84,46,26,24)],jumping:new Sprite(g_images.megaman_sprite,146,40,29,30)},g_sprites.bullet=new Sprite(g_images.bullet_sprite),g_sprites.brick=new Sprite(g_images.brick),entityManager.init(),createMegaman(),main.init()}var g_canvas=document.getElementById("myCanvas"),g_ctx=g_canvas.getContext("2d"),NOMINAL_UPDATE_INTERVAL=16.666,SECS_TO_NOMINALS=1e3/NOMINAL_UPDATE_INTERVAL,consts={FULL_CIRCLE:2*Math.PI,RADIANS_PER_DEGREE:Math.PI/180},util={circlesCollides:function(e,t,i,a,n,s){var r=util.square(i-s),o=util.square(i+s),l=util.square(e-a),p=util.square(t-n),u=l+p;return u>=r&&o>=u},clampRange:function(e,t,i){return t>e?e=t:e>i&&(e=i),e},wrapRange:function(e,t,i){for(;t>e;)e+=i-t;for(;e>i;)e-=i-t;return e},isBetween:function(e,t,i){return t>e?!1:e>i?!1:!0},almostEqual:function(e,t){return Math.abs(this.square(e)-this.square(t))<.1},randRange:function(e,t){return e+Math.random()*(t-e)},square:function(e){return e*e},distSq:function(e,t,i,a){return this.square(i-e)+this.square(a-t)},wrappedDistSq:function(e,t,i,a,n,s){var r=Math.abs(i-e),o=Math.abs(a-t);return r>n/2&&(r=n-r),o>s/2&&(o=s-o),this.square(r)+this.square(o)},playSoundNow:function(e,t){void 0===t&&(t=0),e.currentTime>t&&(e.pause(),e.currentTime=0),e.play()},clearCanvas:function(e){var t=e.fillStyle;e.fillStyle="black",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=t},strokeCircle:function(e,t,i,a){e.beginPath(),e.arc(t,i,a,0,2*Math.PI),e.stroke()},fillCircle:function(e,t,i,a){e.beginPath(),e.arc(t,i,a,0,2*Math.PI),e.fill()},strokeBox:function(e,t,i,a,n){e.beginPath(),e.rect(t,i,a,n),e.stroke()},fillBox:function(e,t,i,a,n,s){var r=e.fillStyle;e.fillStyle=s,e.fillRect(t,i,a,n),e.fillStyle=r}},keys=[],keyUpKeys=[];window.addEventListener("keydown",handleKeydown),window.addEventListener("keyup",handleKeyup);var g_mouseX=0,g_mouseY=0;window.addEventListener("mousedown",handleMouse),window.addEventListener("mousemove",handleMouse);var spatialManager={_nextSpatialID:1,_entities:[],getNewSpatialID:function(){return this._nextSpatialID++},register:function(e){var t=e.getPos(),i=e.getSpatialID(),a=e.sprite.width*e._scale,n=e.sprite.height*e._scale;this._entities[i]={posX:t.posX-a/2,posY:t.posY-n/2,width:a,height:n}},unregister:function(e){var t=e.getSpatialID(),i=this._entities[t];i&&(i.posY=void 0,i.posX=void 0)},findEntityInRange:function(e,t,i){return entityManager.deferredSetup(),!1},render:function(e){var t=e.strokeStyle;e.strokeStyle="red";for(var i in this._entities){var a=this._entities[i];util.strokeBox(e,a.posX,a.posY,a.width,a.height)}e.strokeStyle=t}},entityManager={_character:[],_bullets:[],_bShowRocks:!0,_forEachOf:function(e,t){for(var i=0;i<e.length;++i)t.call(e[i])},KILL_ME_NOW:-1,deferredSetup:function(){this._categories=[this._bullets,this._character]},init:function(){},fireBullet:function(e,t,i,a){this._bullets.push(new Bullet({cx:e,cy:t,velX:i,velY:a}))},generateMegaman:function(e){this._character.push(new Megaman(e))},yoinkMegamanToPos:function(e,t){},update:function(e){for(var t=0;t<this._categories.length;++t)for(var i=this._categories[t],a=0;a<i.length;){var n=i[a].update(e);n===this.KILL_ME_NOW?i.splice(a,1):++a}},render:function(e){for(var t=10,i=100,a=0;a<this._categories.length;++a){for(var n=this._categories[a],s=0;s<n.length;++s)n[s].render(e);i+=10}}};entityManager.deferredSetup(),Sprite.prototype.drawCentredAt=function(e,t,i,a,n){void 0===n&&(n=0);var s=this.width,r=this.height;e.save(),e.translate(t,i),e.rotate(n),e.scale(this.scale,this.scale),a&&e.scale(-1,1),e.drawImage(this.image,this.sx,this.sy,s,r,-s/2,-r/2,s,r),a&&e.scale(-1,1),e.restore()},Sprite.prototype.drawWrappedCentredAt=function(e,t,i,a,n){var s=g_canvas.width;this.drawWrappedVerticalCentredAt(e,t,i,a,n)},Sprite.prototype.drawWrappedVerticalCentredAt=function(e,t,i,a,n){var s=g_canvas.height;this.drawCentredAt(e,t,i,a,n)},Entity.prototype.setup=function(e){for(var t in e)this[t]=e[t];this._spatialID=spatialManager.getNewSpatialID(),this._isDeadNow=!1},Entity.prototype.setPos=function(e,t){this.cx=e,this.cy=t},Entity.prototype.getPos=function(){return{posX:this.cx,posY:this.cy}},Entity.prototype.getRadius=function(){return this.getRadius()},Entity.prototype.getSpatialID=function(){return this._spatialID},Entity.prototype.kill=function(){this._isDeadNow=!0},Entity.prototype.findHitEntity=function(){var e=this.getPos();return spatialManager.findEntityInRange(e.posX,e.posY,this.getRadius())},Entity.prototype.isColliding=function(){return this.findHitEntity()},Entity.prototype.wrapPosition=function(){this.cx=util.wrapRange(this.cx,0,g_canvas.width),this.cy=util.wrapRange(this.cy,0,g_canvas.height)},Bricks.prototype=new Entity,Bricks.prototype.height=0,Bricks.prototype.width=0,Bullet.prototype=new Entity,Bullet.prototype.zappedSound=new Audio("sounds/enemy_takes_hit.wav"),Bullet.prototype.update=function(e){if(spatialManager.unregister(this),this.cx+=this.velX*e,this.cy+=this.velY*e,this.cx>g_canvas.width||this.cx<0)return this.takeBulletHit(),entityManager.KILL_ME_NOW;this.wrapPosition();var t=this.findHitEntity();if(t){var i=t.takeBulletHit;return i&&i.call(t),entityManager.KILL_ME_NOW}spatialManager.register(this)},Bullet.prototype.getRadius=function(){return Math.max(this.sprite.width/2,this.sprite.height/2)*this._scale},Bullet.prototype.takeBulletHit=function(){this.kill(),util.playSoundNow(this.zappedSound,.2)},Bullet.prototype.render=function(e){var t=this.sprite.scale;this.sprite.scale=this._scale,g_sprites.bullet.drawWrappedCentredAt(e,this.cx,this.cy,this.rotation),this.sprite.scale=t},Megaman.prototype=new Entity,Megaman.prototype.KEY_JUMP="W".charCodeAt(0),Megaman.prototype.KEY_LEFT="A".charCodeAt(0),Megaman.prototype.KEY_RIGHT="D".charCodeAt(0),Megaman.prototype.KEY_FIRE=" ".charCodeAt(0),Megaman.prototype.launchVel=2,Megaman.prototype.numSubSteps=1,Megaman.prototype.isFlipped=!1,Megaman.prototype.jumpSound=new Audio("sounds/megaman_jump.wav"),Megaman.prototype.fireSound=new Audio("sounds/megaman_fire_bullet.wav");var g_runningSprite=0,g_bulletSpriteCnt=0,g_hasShotBullet=!1;Megaman.prototype._updateSprite=function(e,t){var i=this.velX,a=this.velY,n=8;if(0>i?this.isFlipped=!0:i>0&&(this.isFlipped=!1),0===e&&(g_runningSprite=0),this._isFiringBullet&&(g_hasShotBullet=!0,g_bulletSpriteCnt++),0!==a)this.sprite=g_hasShotBullet&&g_hasShotBullet?g_sprites.megaman_fire.jumping:g_sprites.megaman_jump;else if(0===i)this.sprite=g_hasShotBullet&&g_hasShotBullet?g_sprites.megaman_fire.still:g_sprites.megaman_still;else{var s=Math.floor(g_runningSprite++/n);this.sprite=g_hasShotBullet&&g_hasShotBullet?g_sprites.megaman_fire.running[s]:g_sprites.megaman_running[s]}g_runningSprite>=g_sprites.megaman_running.length*n&&(g_runningSprite=0),g_hasShotBullet&&20>g_bulletSpriteCnt?g_bulletSpriteCnt++:(g_bulletSpriteCnt=0,g_hasShotBullet=!1)},Megaman.prototype.update=function(e){if(spatialManager.unregister(this),this._isDeadNow)return spatialManager.KILL_ME_NOW;for(var t=this.velX,i=this.velY,a=this.numSubSteps,n=e/a,s=0;a>s;++s)this.computeSubStep(n);this.maybeFireBullet(),spatialManager.register(this),this._updateSprite(t,i),this.isColliding()||spatialManager.register(this)},Megaman.prototype.computeSubStep=function(e){this.updatePosition(e)};var NOMINAL_GRAVITY=.7;Megaman.prototype.computeGravity=function(){return NOMINAL_GRAVITY},Megaman.prototype.computeThrustX=function(){var e=0;return keys[this.KEY_RIGHT]&&(e+=this._verticalSpeed),keys[this.KEY_LEFT]&&(e-=this._verticalSpeed),e},Megaman.prototype.updatePosition=function(e){var t=this.sprite.width/2*this._scale,i=this.sprite.height/2*this._scale,a=g_canvas.width-t,n=t,s=g_canvas.height-i,r=i,o=this.velX,l=this.velY,p=this.computeGravity();this.velX=this.computeThrustX(),this.cx=util.clampRange(this.cx+e*this.velX,n,a),keyUpKeys[this.KEY_JUMP]&&(this._hasJumped=!1),0===l&&keys[this.KEY_JUMP]&&!this._hasJumped&&(this.velY=this._initialJumpSpeed,this._hasJumped=!0),0!==l&&(util.almostEqual(l,0)?this.velY=-.5:this.velY-=p*e),this.cy-=e*this.velY,this.cy>s&&(this.cy=s,this.velY=0,util.playSoundNow(this.jumpSound)),this.cy=util.clampRange(this.cy,r,s)},Megaman.prototype.maybeFireBullet=function(){if(keyUpKeys[this.KEY_FIRE]&&(this._isFiringBullet=!1),keys[this.KEY_FIRE]&&!this._isFiringBullet){var e=0,t=this.isFlipped?-10:10;entityManager.fireBullet(this.cx,this.cy,t,e),util.playSoundNow(this.fireSound,.2),this._isFiringBullet=!0}},Megaman.prototype.getRadius=function(){return Math.max(this.sprite.width,this.sprite.height)/2*this._scale},Megaman.prototype.halt=function(){this.velX=0,this.velY=0},Megaman.prototype.render=function(e){var t=this.sprite.scale;this.sprite.scale=this._scale,this.sprite.drawWrappedCentredAt(e,this.cx,this.cy,this.isFlipped),this.sprite.scale=t};var NOMINAL_UPDATE_INTERVAL=16.666,g_prevUpdateDt=null,g_prevUpdateDu=null,g_isUpdateOdd=!1,KEY_PAUSE="P".charCodeAt(0),KEY_STEP="O".charCodeAt(0),g_isUpdatePaused=!1,g_doClear=!0,g_doBox=!1,g_undoBox=!1,g_doFlipFlop=!1,g_doRender=!0,g_frameCounter=1,TOGGLE_CLEAR="C".charCodeAt(0),TOGGLE_BOX="B".charCodeAt(0),TOGGLE_UNDO_BOX="U".charCodeAt(0),TOGGLE_FLIPFLOP="F".charCodeAt(0),TOGGLE_RENDER="R".charCodeAt(0),canvas=document.getElementById("myCanvas"),ctx=canvas.getContext("2d");Image.prototype.asyncLoad=function(e,t){this.onload=t,this.onerror=t,console.log("requesting image src of ",e),this.src=e};var main={_frameTime_ms:null,_frameTimeDelta_ms:null};main.iter=function(e){this._updateClocks(e),this._iterCore(this._frameTimeDelta_ms),this._debugRender(g_ctx),this._isGameOver||this._requestNextIteration()},main._updateClocks=function(e){null===this._frameTime_ms&&(this._frameTime_ms=e),this._frameTimeDelta_ms=e-this._frameTime_ms,this._frameTime_ms=e},main._iterCore=function(e){return requestedQuit()?void this.gameOver():(gatherInputs(),update(e),void render(g_ctx))},main._isGameOver=!1,main.gameOver=function(){this._isGameOver=!0,console.log("gameOver: quitting...")};var KEY_QUIT="Q".charCodeAt(0);window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame,main._requestNextIteration=function(){window.requestAnimationFrame(mainIterFrame)};var TOGGLE_TIMER_SHOW="T".charCodeAt(0);main._doTimerShow=!1,main._debugRender=function(e){if(eatKey(TOGGLE_TIMER_SHOW)&&(this._doTimerShow=!this._doTimerShow),this._doTimerShow){var t=350;e.fillText("FT "+this._frameTime_ms,50,t+10),e.fillText("FD "+this._frameTimeDelta_ms,50,t+20),e.fillText("UU "+g_prevUpdateDu,50,t+30),e.fillText("FrameSync ON",50,t+40)}},main.init=function(){g_ctx.fillStyle="white",this._requestNextIteration()};var g_canvas=document.getElementById("myCanvas"),g_ctx=g_canvas.getContext("2d"),g_renderSpatialDebug=!1,KEY_SPATIAL=keyCode("X"),g_images={},g_sprites={};requestPreloads();
//# sourceMappingURL=./GAME.min.js.map